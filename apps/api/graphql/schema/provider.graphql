"""
Storage provider management
"""
enum ProviderType {
	GOOGLE_DRIVE
	S3
	LOCAL
	DROPBOX
	FTP
	WEBDAV
	TELEGRAM
	NEXTCLOUD
}

"""
Authentication mechanism used by a storage provider
"""
enum AuthType {
	OAUTH
	API_KEY
	EMAIL_PASS
	NO_AUTH
}

"""
Origin of OAuth initiation, used to decide callback redirect behavior.
"""
enum OAuthInitiator {
	ONBOARDING
}

type StorageProvider {
	id: ID!
	name: String!
	type: ProviderType!
	authType: AuthType!
	userId: ID!
	isActive: Boolean!
	accountEmail: String
	accountName: String
	configPreview: [ProviderConfigPreviewEntry!]!
	quotaTotal: Float
	quotaUsed: Float!
	lastSyncAt: DateTime
	createdAt: DateTime!
	updatedAt: DateTime!
}

type ProviderConfigPreviewEntry {
	key: String!
	value: String!
	isSensitive: Boolean!
}

type ProviderConfigField {
	name: String!
	label: String!
	type: String!
	required: Boolean!
	isIdentifier: Boolean!
	description: String
	placeholder: String
}

type OAuthProviderCredential {
	id: ID!
	type: ProviderType!
	identifierLabel: String!
	identifierValue: String!
	createdAt: DateTime!
	updatedAt: DateTime!
}

type AvailableProvider {
	id: String!
	name: String!
	description: String!
	authType: AuthType!
	"""
	Whether this provider uses poll-based auth (popup + poll instead of redirect)
	"""
	usesPollingAuth: Boolean!
	configFields: [ProviderConfigField!]!
}

"""
Result of initiating an OAuth flow
"""
type OAuthInitResult {
	authorizationUrl: String!
	state: String!
}

extend type Query {
	"""
	Get all storage providers for current user
	"""
	storageProviders: [StorageProvider!]!

	"""
	Get storage provider by ID
	"""
	storageProvider(id: ID!): StorageProvider

	"""
	Get list of available storage provider types
	"""
	availableProviders: [AvailableProvider!]!

	"""
	Get reusable OAuth app credentials for the current user and provider type
	"""
	oauthProviderCredentials(type: ProviderType!): [OAuthProviderCredential!]!
}

input SyncOptionsInput {
	recursive: Boolean
	pruneDeleted: Boolean
}

extend type Mutation {
	"""
	Connect a new storage provider
	"""
	connectStorage(input: ConnectStorageInput!): StorageProvider!

	"""
	Disconnect and remove storage provider
	"""
	disconnectProvider(id: ID!): Boolean!

	"""
	Sync provider quota and metadata
	"""
	syncProvider(id: ID!, options: SyncOptionsInput): StorageProvider!

	"""
	Update provider quota settings manually
	"""
	updateProviderQuota(input: UpdateProviderQuotaInput!): StorageProvider!

	"""
	Initiate the OAuth flow for an OAuth-type provider.
	Returns the authorization URL to redirect the user to.
	The OAuth callback is handled via GET /webhook/callback/:id
	"""
	initiateProviderOAuth(id: ID!, source: OAuthInitiator): OAuthInitResult!

	"""
	Create and save reusable OAuth app credentials for a provider
	"""
	createOAuthProviderCredential(
		input: CreateOAuthProviderCredentialInput!
	): OAuthProviderCredential!

	"""
	Poll-based auth for providers that don't redirect back (e.g. Login Flow v2).
	Returns pending status or the activated provider on success.
	The frontend calls this repeatedly after opening the auth popup.
	"""
	pollProviderAuth(id: ID!): PollProviderAuthResult!
}

input UpdateProviderQuotaInput {
	id: ID!
	quotaTotal: Float
	quotaUsed: Float!
}

input ConnectStorageInput {
	name: String!
	type: ProviderType!
	config: JSON
	oauthCredentialId: ID
}

input CreateOAuthProviderCredentialInput {
	type: ProviderType!
	config: JSON!
}

"""
Result of polling a provider's auth flow
"""
type PollProviderAuthResult {
	"""
	Whether auth is still pending or completed successfully
	"""
	status: String!
	"""
	The activated provider (only present when status is success)
	"""
	provider: StorageProvider
}

type SyncProgress {
	providerId: ID!
	processed: Int!
	total: Int
	message: String
	status: String! # "running" | "completed" | "error"
}

type Subscription {
	providerSyncProgress(providerId: ID!): SyncProgress!
}
